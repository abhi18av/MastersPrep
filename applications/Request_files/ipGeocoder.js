'use strict';(function(){inproces.factory('ipGeocoder',function($q,$timeout){var locations={};var queue=[];var queryPause=250;var executeNext=function(){var task=queue[0],geocoder=new google.maps.Geocoder();var params=task.latlng?{latLng:task.latlng}:{address:task.address};geocoder.geocode(params,function(result,status){if(status===google.maps.GeocoderStatus.OK){var latLng={lat:result[0].geometry.location.lat(),lng:result[0].geometry.location.lng()};queue.shift();locations[task.address]=latLng;if(task.address){task.d.resolve(latLng);}else{var selectie={};var resultMapping={'postal_code':'postcode','street_number':'huisnummer','street_address':'adres','route':'straatnaam','locality':'woonplaatsnaam','sublocality':'wijk','administrative_area_level_1':'provincie','administrative_area_level_2':'gemeente','administrative_area_level_3':'deelgemeente','country':'land'};result.forEach(function(geocoderResult){var locatieType=resultMapping[geocoderResult.types[0]];if(locatieType){selectie[locatieType]={};selectie[locatieType].lat=geocoderResult.geometry.location.lat();selectie[locatieType].lng=geocoderResult.geometry.location.lng();selectie[locatieType].precisie=geocoderResult.geometry.location_type;selectie[locatieType].adres=geocoderResult.formatted_address;geocoderResult.address_components.forEach(function(addressComponent){if(resultMapping[addressComponent.types[0]]){selectie[locatieType][resultMapping[addressComponent.types[0]]]=addressComponent.long_name;if(addressComponent.long_name!==addressComponent.short_name){selectie[locatieType].waarde=addressComponent.long_name;selectie[locatieType].afkorting=addressComponent.short_name;}}});}});if(selectie.adres&&selectie.adres.postcode){selectie.adres.postcode=selectie.adres.postcode.replace(' ','');}
selectie.data=selectie.adres||selectie.straatnaam||selectie.postcode||selectie.woonplaatsnaam;if(selectie.data.huisnummer){var huisnummer=selectie.data.huisnummer;var huisnummertext=selectie.data.huisnummer.replace(/[0-9]/g,'');selectie.data.huisnummer=parseInt(huisnummer);selectie.data.huisletter=huisnummertext[0]||'';selectie.data.huisnummertoevoeging=huisnummertext.substr(1)||'';}
task.d.resolve(selectie);}
if(queue.length){$timeout(executeNext,queryPause);}}else if(status===google.maps.GeocoderStatus.ZERO_RESULTS){queue.shift();task.d.reject({type:'zero',message:'Zero results for geocoding address '+task.address});}else if(status===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){queryPause+=250;$timeout(executeNext,queryPause);}else if(status===google.maps.GeocoderStatus.REQUEST_DENIED){queue.shift();task.d.reject({type:'denied',message:'Request denied for geocoding address '+task.address});}else if(status===google.maps.GeocoderStatus.INVALID_REQUEST){queue.shift();task.d.reject({type:'invalid',message:'Invalid request for geocoding address '+task.address});}});};return{latLngForAddress:function(address){var d=$q.defer();if(_.has(locations,address)){$timeout(function(){d.resolve(locations[address]);});}else{queue.push({address:address,d:d});if(queue.length===1){executeNext();}}
return d.promise;},addressForLatLng:function(coords){var latlng=new google.maps.LatLng(coords.lat,coords.lng);var d=$q.defer();if(_.has(locations,latlng)){$timeout(function(){d.resolve(locations[latlng]);});}else{queue.push({latlng:latlng,d:d});if(queue.length===1){executeNext();}}
return d.promise;},extractLocation:function(geocoderResult){var resultMapping={'postal_code':'postcode','street_number':'huisnummer','street_address':'adres','route':'straatnaam','locality':'woonplaatsnaam','sublocality':'wijk','administrative_area_level_1':'provincie','administrative_area_level_2':'gemeente','administrative_area_level_3':'deelgemeente','country':'land'};var location={};var locationType=resultMapping[geocoderResult.types[0]];if(locationType){location[locationType]={};location[locationType].lat=geocoderResult.geometry.location.lat;location[locationType].lng=geocoderResult.geometry.location.lng;location[locationType].precisie=geocoderResult.geometry.location_type;location[locationType].adres=geocoderResult.formatted_address;geocoderResult.address_components.forEach(function(adresComponent){if(resultMapping[adresComponent.types[0]]){location[locationType][resultMapping[adresComponent.types[0]]]=adresComponent.long_name;if(adresComponent.long_name!==adresComponent.short_name){location[locationType].waarde=adresComponent.long_name;location[locationType].afkorting=adresComponent.short_name;}}});}
if(location.adres&&location.adres.postcode){location.adres.postcode=location.adres.postcode.replace(' ','');}
location.data=location.adres||location.straatnaam||location.postcode||location.woonplaatsnaam;if(location.data&&location.data.huisnummer){var huisnummer=location.data.huisnummer;var huisnummertext=location.data.huisnummer.replace(/[0-9]/g,'');location.data.huisnummer=parseInt(huisnummer);location.data.huisletter=huisnummertext[0]||'';location.data.huisnummertoevoeging=huisnummertext.substr(1)||'';}
return location;}};});})();