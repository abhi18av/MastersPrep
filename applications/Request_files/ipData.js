
(function(){'use strict';inproces.factory('ipData',function($q,$http,ipRecord,ipStore,$filter){return{create:function(data,metadata){var record=new ipRecord(data,metadata);this.data[record.data.docunid]=record;return record;},read:function(options){var d=$q.defer();$http({url:'/api/'+options.schema+'/read/'+(options.docunid||options.sleutel)}).then(function(response){var data=response.data;var metadata={fields:[]};var key;for(key in response.data){var ismultivalue=angular.isArray(data[key]);var type=typeof(ismultivalue?(data[key][0]||''):data[key]);metadata.fields.push({name:key,type:type,ismultivalue:ismultivalue});}
var record=this.create(data,metadata);d.resolve(record);}.bind(this),function(reason){d.reject(reason);}.bind(this));return d.promise;},search:function(options){var d=$q.defer();var params=angular.extend({metadata:true,search:options.search||'*'},options);$http({url:'/api/'+options.schema+'/search',method:'POST',params:params}).then(function(response){var store=new ipStore(response);d.resolve(store);}.bind(this),function(reason){d.reject(reason);}.bind(this));return d.promise;},http:function(options){var d=$q.defer();var url='/entiteitproxy';var params={action:'evaluate'};params.ipml='<http>';params.ipml+='<method>'+(options.method||'GET')+'</method>';params.ipml+='<url>'+options.url+'</url>';params.ipml+='<headers>'+(options.headers||'')+'</headers>';params.ipml+='<params>'+(options.params||'')+'</params>';params.ipml+='</http>';$http({url:url,params:params,method:'POST'}).then(function(response){var data=response.data.result;if(data.substr(0,5)==='<?xml'){data=$filter('text2xml')(data);data=$filter('xml2js')(data);}else{try{data=JSON.parse(data);}catch(e){}}
d.resolve(data);},function(reason){d.reject(reason);});return d.promise;},data:{}};}).factory('ipStore',function($rootScope,ipRecord){function ipStore(response){this.data=[];this.keys={};if(response.data.metaData){this.metadata=response.data.metaData;this.metadata.search=response.config.params.search;this.metadata.schema=response.config.params.schema;}
angular.forEach(response.data.rows,function(row){var record=new ipRecord(row,this.metadata);this.addRecord(record);},this);$rootScope.$on(response.config.params.schema+'.save',function(record){});}
ipStore.prototype={addRecord:function(record){this.keys[record.data.docunid]=record;this.keys[record.data.sleutel]=record;return this.data.push(record);}};return ipStore;}).factory('ipRecord',function($rootScope,$q,$http,ipCreateFormPost,ipUtils,Upload,ipFile){function ipRecord(data,metadata){this.data=data;this.metadata=metadata;if(!this.metadata){this.metadata={fields:[]};angular.forEach(this.data,function(fieldname){var field={name:fieldname};this.metadata.fields.push(field);},this);}
angular.forEach(this.metadata.fields,function(field){this.metadata.fields[field.name]=field;},this);this.updateCollections();this.initialdata=angular.extend({},data);$rootScope.$broadcast(this.data.schema+'.create',this);}
ipRecord.prototype={set:function(name,value){if(!this.initialdata[name]||this.data[name]!==value){this.initialdata[name]=this.initialdata[name]||this.data[name];this.data[name]=value;this.dirty=true;$rootScope.$broadcast(this.data.schema+'.update',this,name,value,this.initialdata[name]);}},submit:function(data){var d=$q.defer();angular.forEach(this.data,function(value,key){if(angular.isArray(this.data[key])&&this.data[key].length===0){this.data[key]="";}},this);$http({method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},url:'/api/'+this.data.schema+'/submit/'+(this.data.docunid||this.data.sleutel||'')+'?format=json&metadata=true',data:this.data,transformRequest:ipCreateFormPost}).then(function(response){if(angular.isArray(response.data)){this.data=response.data[0];this.context=new ipRecord(response.data[1]);}else{this.data=response.data;}
this.updateCollections();$rootScope.$broadcast(this.data.schema+'.save',this);d.resolve(this);}.bind(this),function(reason){d.reject(reason);}.bind(this));return d.promise;},remove:function(){var d=$q.defer();$http({method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},url:'/entiteitproxy?action=remove&schema='+this.data.schema+'&docunid='+this.data.docunid+'&format=json'}).then(function(response){this.data={};this.initialdata={};$rootScope.$broadcast(this.data.schema+'.remove',response);d.resolve(this);}.bind(this),function(reason){d.reject(reason);}.bind(this));return d.promise;},updatebewerking:function(){var d=$q.defer();$http({method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},url:'/entiteitproxy?action=updatebewerking&schema='+this.data.schema+'&docunid='+this.data.docunid+'&format=json',data:this.data,transformRequest:ipCreateFormPost,transformResponse:this.transformDxl}).then(function(response){this.record.data=response;this.record.initialdata=response;$rootScope.$broadcast(this.data.schema+'.updatebewerking',response);d.resolve(this);}.bind(this),function(reason){d.reject(reason);}.bind(this));return d.promise;},updateCollections:function(){if(this.metadata&&this.metadata.fieldsets){this.collections={};angular.forEach(this.metadata.fieldsets,function(fieldset){if(fieldset.iscollection){this.collections[fieldset.name]=ipUtils.detailStore(this.data,fieldset.fields);}},this);}
var files=ipUtils.detailStore(this.data,['bijlagenaam','bijlagecontenttype','bijlagegrootte','bijlageveldnaam','bijlageomschrijving','bijlageurl']);this.files=[];angular.forEach(files,function(file){this.files.push(new ipFile(file,this));},this);},upload:function(files){var file=files.shift();var uploaded=[];var d=$q.defer();Upload.upload({url:'/entiteitproxy?action=createbijlage&docunid='+this.data.docunid+'&schema='+this.data.schema+'&outputformat=json&filename='+encodeURIComponent(file.name),data:{file:file}}).then(function(response){var file=new ipFile({bijlagenaam:response.config.data.file.name,bijlageomschrijving:response.config.data.file.name,bijlagegrootte:response.config.data.file.size,bijlagecontenttype:response.config.data.file.type,bijlageurl:'/data/'+this.data.schema+'/'+this.data.docunid+'/'+file.name});uploaded.push(file);this.files.push(file);if(files.length>0){this.upload(files);}else{d.resolve(uploaded);}}.bind(this),function(response){d.reject(response);}.bind(this),function(evt){this.progress=Math.min(100,parseInt(100.0*evt.loaded/evt.total));d.notify(this.progress);}.bind(this));return d.promise;}};return ipRecord;}).factory('ipFile',function($rootScope,$q,$http,deviceDetector){function ipFile(file,record){angular.extend(this,file);this.record=record;return this;}
ipFile.prototype={edit:function(){var d=$q.defer();$http({url:'/browse/ssourl'}).then(function(response){var url='//'+window.location.hostname+'/browse/'+response.data.ssoid+'/'+this.record.data.schema+'/'+this.record.data.docunid+'/'+this.bijlagenaam;var protocol=window.location.protocol;var doc;if(deviceDetector.os==="windows"){var msofficeSchemes={'application/msword':'ms-word','application/vnd.ms-excel':'ms-excel','application/x-msaccess':'ms-access','application/vnd.ms-project':'ms-project','application/vnd.ms-powerpoint':'ms-powerpoint','application/vnd.openxmlformats-officedocument.wordprocessingml.document':'ms-word','application/vnd.openxmlformats-officedocument.wordprocessingml.template':'ms-word','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':'ms-excel','application/vnd.openxmlformats-officedocument.presentationml.presentation':'ms-powerpoint','application/vnd.openxmlformats-officedocument.presentationml.template':'ms-powerpoint','application/x-mspublisher':'ms-publisher','application/vnd.oasis.opendocument.text':'ms-word','application/vnd.oasis.opendocument.spreadsheet':'ms-excel','application/vnd.oasis.opendocument.presentation':'ms-powerpoint'};var mso=msofficeSchemes[this.bijlagecontenttype]||'ms-word';protocol=mso+":ofe|u|"+window.location.protocol;doc=window.open(protocol+url,"_blank");if(doc){doc.close();}}else if(deviceDetector.os==="mac"){var sharepointCtrl=angular.element('<object type="application/x-sharepoint" style="visibility:hidden;" width="0" heigh="0"></object>');angular.element(document.body).append(sharepointCtrl);sharepointCtrl[0].EditDocument(protocol+url);}else{protocol="dav:";doc=window.open(protocol+url,"_blank");if(doc){doc.close();}}}.bind(this),function(response,request){d.reject('Bijlage '+this.get('bijlagenaam')+' kan niet worden bewerkt.');}.bind(this));return d.promise;},remove:function(){this.destroy();}};return ipFile;});})();